// Generated by BUCKLESCRIPT VERSION 5.0.4, PLEASE EDIT WITH CARE
'use strict';

var Json_decode = require("@glennsl/bs-json/src/Json_decode.bs.js");
var Caml_exceptions = require("bs-platform/lib/js/caml_exceptions.js");
var PayloadTypes$BsDiscord = require("./PayloadTypes.bs.js");
var PayloadParser$BsDiscord = require("./PayloadParser.bs.js");
var WebsocketClient$BsDiscord = require("./WebsocketClient.bs.js");

var Unsupported = Caml_exceptions.create("App-BsDiscord.Unsupported");

var ws = WebsocketClient$BsDiscord.Websocket[/* make */2](undefined, "wss://gateway.discord.gg/?v=6&encoding=json");

WebsocketClient$BsDiscord.Websocket[/* onOpen */4](ws, (function (param) {
        console.log("onOpen");
        return WebsocketClient$BsDiscord.Websocket[/* send */8](ws, JSON.stringify({
                        op: PayloadTypes$BsDiscord.opCodeToJs(/* Identify */2),
                        d: {
                          token: "Mzk4OTE3OTQzNTc0MTM0Nzk1.XRKUnA.KNRkoqpdhZVMEvD3ti0abVECf-k",
                          properties: {
                            $os: "darwin",
                            $browser: "bs-discord",
                            $device: "bs-discord"
                          }
                        }
                      }));
      }));

var lastSequenceId = /* record */[/* contents */undefined];

function handleMessage(message) {
  if (typeof message === "number" || message.tag) {
    return /* () */0;
  } else {
    setInterval((function (param) {
            console.log("heartbeat");
            var match = lastSequenceId[0];
            return WebsocketClient$BsDiscord.Websocket[/* send */8](ws, JSON.stringify({
                            op: PayloadTypes$BsDiscord.opCodeToJs(/* Heartbeat */1),
                            d: match !== undefined ? match : null
                          }));
          }), message[0][/* heartbeatInterval */0]);
    return /* () */0;
  }
}

WebsocketClient$BsDiscord.Websocket[/* onMessage */7](ws, (function (ev) {
        console.log(ev.data);
        var json = JSON.parse(ev.data);
        var match = Json_decode.field("s", (function (param) {
                return Json_decode.optional(Json_decode.$$int, param);
              }), json);
        if (match !== undefined) {
          lastSequenceId[0] = match;
        }
        var message = PayloadParser$BsDiscord.parseSocketData(json);
        console.log("onMessage", message);
        handleMessage(message);
        return /* () */0;
      }));

WebsocketClient$BsDiscord.Websocket[/* onError */5](ws, (function (ev) {
        console.log("onError: " + (String(ev) + ""));
        return WebsocketClient$BsDiscord.Websocket[/* close */3](undefined, undefined, ws);
      }));

WebsocketClient$BsDiscord.Websocket[/* onClose */6](ws, (function (ev) {
        console.log("onClose", ev);
        return /* () */0;
      }));

exports.Unsupported = Unsupported;
exports.ws = ws;
exports.lastSequenceId = lastSequenceId;
exports.handleMessage = handleMessage;
/* ws Not a pure module */
